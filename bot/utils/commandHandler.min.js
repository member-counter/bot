const{loadCommands:loadCommands,loadLanguagePack:loadLanguagePack}=require("./commandHandler/utils"),GuildModel=require("../../mongooseModels/GuildModel"),memberHasPermission=require("./memberHasPermissions"),sendStats=require("./stats.js"),{DISCORD_PREFIX:DISCORD_PREFIX,DISCORD_DEFAULT_LANG:DISCORD_DEFAULT_LANG}=process.env;let commands=[];module.exports=async message=>{const{client:client,guild:guild,channel:channel,author:author,content:content,member:member}=message;if(0===commands.length&&(commands=await loadCommands()),client.user.id!==author.id&&!author.bot){let prefix=DISCORD_PREFIX,languagePack=await loadLanguagePack(DISCORD_DEFAULT_LANG),guildSettings={prefix:prefix};guild&&(prefix=(guildSettings=await GuildModel.findOneAndUpdate({guild_id:guild.id},{},{new:!0,upsert:!0}).catch(console.error)).prefix,languagePack=await loadLanguagePack(guildSettings.lang));const commandRequested=content.toLowerCase();commandsLoop:for(let i=0;i<commands.length;i++){const commandToCheck=commands[i];for(let ii=0;ii<commandToCheck.variants.length;ii++){const commandVariant=commandToCheck.variants[ii].replace(/\{PREFIX\}/i,prefix).toLowerCase();if((commandToCheck.indexZero?commandRequested.startsWith(commandVariant):commandRequested.includes(commandVariant))&&(sendStats(commandToCheck.name),commandToCheck.enabled)){if(commandToCheck.allowedTypes.includes(channel.type)){if("text"!==channel.type&&"news"!==channel.type||!commandToCheck.requiresAdmin||memberHasPermission(member,guildSettings)){console.log(`[Bot shard #${client.shard.id}] ${author.tag} (${author.id}) [${guild?`Server: ${guild.name} (${guild.id}), `:""}${channel.name?`Channel: ${channel.name}, `:""}Channel type: ${channel.type} (${channel.id})]: ${content}`),commandToCheck.run({message:message,guildSettings:guildSettings,languagePack:languagePack});break commandsLoop}channel.send(languagePack.common.error_no_admin).catch(console.error);break commandsLoop}channel.send(languagePack.functions.commandHandler.invalid_channel.replace("{TYPE}",channel.type)).catch(console.error)}}}}};